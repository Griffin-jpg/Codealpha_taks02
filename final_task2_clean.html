<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöÄ Advanced Data Analytics - Task 2 | CodeAlpha Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-logo">üöÄ DATA AI</div>
        <div class="loading-subtitle">Initializing Advanced Analytics Engine...</div>
        <div class="loading-progress">
            <div class="loading-bar"></div>
        </div>
        <div style="font-size: 0.9em; opacity: 0.7; margin-top: 20px;">
            <i class="fas fa-brain"></i> Loading Machine Learning Algorithms...
        </div>
    </div>

    <!-- Theme Toggle -->
    <button class="theme-toggle" id="themeToggle" title="Switch Theme">
        <i class="fas fa-moon"></i>
    </button>

    <!-- Theme Indicator -->
    <div class="theme-indicator" id="themeIndicator">üåô DARK</div>

    <!-- Floating Notification -->
    <div class="notification" id="floatingNotification">
        <i class="fas fa-check-circle"></i>
        <strong>Welcome!</strong><br>
        Upload a CSV file to begin advanced data analysis ‚ú®
    </div>

    <!-- Header -->
    <div class="header interactive-gradient-bg">
        <!-- Floating Particles -->
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>

        <h1 class="header-title glow-text">üöÄ Advanced Data Analytics Dashboard</h1>
        <p class="header-subtitle"><strong>CodeAlpha Internship - Task 2 Professional Solution</strong></p>
        <p class="header-description">
            Complete Data Science Methodology: Questions ‚Üí Exploration ‚Üí Patterns ‚Üí Hypothesis Testing ‚Üí Quality Assessment<br>
            Professional analytics with real-time visualizations and comprehensive insights
        </p>
    </div>

    <div class="container">
        <!-- Upload Section -->
        <div class="upload-section">
            <h2 class="section-title">üìä Data Upload & Analysis</h2>

            <div class="error-message status-message" id="errorMessage" style="display: none;">
                <i class="fas fa-exclamation-triangle"></i> Error processing data
            </div>
            <div class="success-message status-message" id="successMessage" style="display: none;">
                <i class="fas fa-check-circle"></i> Data successfully loaded and analyzed!
            </div>

            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">
                    <i class="fas fa-cloud-upload-alt"></i>
                </div>
                <h3>Upload Your CSV Dataset</h3>
                <p>Drag and drop a CSV file here, or click to browse<br>
                Files supported: CSV format with headers</p>
                <input type="file" class="file-input" id="fileInput" accept=".csv">
                <button class="upload-button">
                    <i class="fas fa-folder-open"></i> Choose File
                </button>
            </div>

            <div class="loading" id="loadingSpinner">
                <div class="loading-spinner"></div>
                <p>Performing advanced data analysis...</p>
            </div>
        </div>

        <!-- Results Section -->
        <div class="results-section" id="resultsSection">
            <!-- Change File Button -->
            <div class="change-file-section" id="changeFileSection" style="text-align: center; margin-bottom: 30px; display: none;">
                <button class="change-file-btn" id="changeFileBtn">
                    <i class="fas fa-exchange-alt"></i> Change Dataset File
                </button>
            </div>

            <!-- Analysis Tabs -->
            <div class="analysis-tabs">
                <button class="tab-button active" data-tab="overview">
                    <i class="fas fa-chart-pie"></i> Overview
                </button>
                <button class="tab-button" data-tab="statistics">
                    <i class="fas fa-calculator"></i> Statistics
                </button>
                <button class="tab-button" data-tab="correlations">
                    <i class="fas fa-link"></i> Relations
                </button>
                <button class="tab-button" data-tab="insights">
                    <i class="fas fa-lightbulb"></i> Insights
                </button>
                <button class="tab-button" data-tab="quality">
                    <i class="fas fa-shield-alt"></i> Quality
                </button>
            </div>

            <!-- Overview Tab -->
            <div class="tab-content active" id="overviewTab">
                <div class="step">
                    <h2>1Ô∏è‚É£ Ask Meaningful Business Questions</h2>
                    <div class="grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                        <div>
                            <h3 style="color: var(--text-primary); margin-bottom: 15px; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">üíº Business Performance</h3>
                            <ul>
                                <li>What are the overall sales performance and revenue trends?</li>
                                <li>Which products and categories generate the most revenue?</li>
                                <li>What are the key performance indicators?</li>
                                <li>How do sales vary across different periods?</li>
                            </ul>
                        </div>
                        <div>
                            <h3 style="color: var(--text-primary); margin-bottom: 15px; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">üë• Customer Analysis</h3>
                            <ul>
                                <li>What is our customer demographic profile?</li>
                                <li>How do different customer segments behave?</li>
                                <li>What factors influence customer satisfaction?</li>
                                <li>Which payment methods are most preferred?</li>
                            </ul>
                        </div>
                    </div>

                    <div style="margin-top: 30px;">
                        <h3 style="color: var(--text-primary); margin-bottom: 15px; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">‚öôÔ∏è Operational Efficiency</h3>
                        <div class="grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                            <div>
                                <ul>
                                    <li>How efficient is our order fulfillment?</li>
                                    <li>Are there regional differences in performance?</li>
                                </ul>
                            </div>
                            <div>
                                <ul>
                                    <li>What payment methods are most popular?</li>
                                    <li>How do discount programs affect revenue?</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <i class="fas fa-database stat-icon"></i>
                        <span class="stat-value" id="totalRecords">0</span>
                        <span class="stat-label">Total Records</span>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-columns stat-icon"></i>
                        <span class="stat-value" id="totalColumns">0</span>
                        <span class="stat-label">Data Variables</span>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-chart-line stat-icon"></i>
                        <span class="stat-value" id="numericFields">0</span>
                        <span class="stat-label">Numeric Fields</span>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-tags stat-icon"></i>
                        <span class="stat-value" id="textFields">0</span>
                        <span class="stat-label">Categorical Fields</span>
                    </div>
                </div>

                <div class="chart-container">
                    <div class="chart-title">üìä Data Structure Overview</div>
                    <canvas id="overviewChart"></canvas>
                </div>

                <div id="overviewContent"></div>
            </div>

            <!-- Statistics Tab -->
            <div class="tab-content" id="statisticsTab">
                <div class="step">
                    <h2>3Ô∏è‚É£ Identify Trends & Statistical Measures</h2>
                    <div id="statisticsContent">Loading advanced statistical analysis...</div>
                </div>

                <div class="chart-container">
                    <div class="chart-title">üìà Statistical Distributions</div>
                    <canvas id="statisticsChart"></canvas>
                </div>
            </div>

            <!-- Correlations Tab -->
            <div class="tab-content" id="correlationsTab">
                <div class="step">
                    <h2>üîó Variable Relationships & Correlations</h2>
                    <div id="correlationsContent">Analyzing variable relationships and correlations...</div>
                </div>

                <div class="chart-container">
                    <div class="chart-title">üîó Correlation Heatmap</div>
                    <canvas id="correlationChart"></canvas>
                </div>
            </div>

            <!-- Insights Tab -->
            <div class="tab-content" id="insightsTab">
                <div class="step">
                    <h2>4Ô∏è‚É£ Hypothesis Testing & Business Intelligence</h2>
                    <div id="insightsContent">Generating business intelligence insights...</div>
                </div>

                <div class="chart-container">
                    <div class="chart-title">üéØ Key Business Insights</div>
                    <canvas id="insightsChart"></canvas>
                </div>
                <div id="hypothesisContent"></div>
            </div>

            <!-- Quality Tab -->
            <div class="tab-content" id="qualityTab">
                <div class="step">
                    <h2>5Ô∏è‚É£ Data Quality Assessment & Recommendations</h2>
                    <div id="qualityContent">Performing comprehensive data quality assessment...</div>
                </div>

                <div class="chart-container">
                    <div class="chart-title">üèÜ Data Quality Overview</div>
                    <canvas id="qualityChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- PDF Download Button -->
    <button class="pdf-download-btn" id="pdfDownloadBtn" title="Download Analysis as PDF" style="display: none;">
        <i class="fas fa-file-pdf"></i> <span>Download PDF</span>
    </button>

    <script>
        // Global variables
        let csvData = [];
        let columnNames = [];
        let analyzedData = {};
        let overviewChart = null;
        let statisticsChart = null;
        let correlationChart = null;
        let insightsChart = null;
        let qualityChart = null;

        // DOM elements
        const themeToggle = document.getElementById('themeToggle');
        const themeIndicator = document.getElementById('themeIndicator');
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const errorMessage = document.getElementById('errorMessage');
        const successMessage = document.getElementById('successMessage');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const resultsSection = document.getElementById('resultsSection');
        const changeFileSection = document.getElementById('changeFileSection');
        const tabButtons = document.querySelectorAll('.tab-button');

        // Loading screen functionality
        window.addEventListener('load', () => {
            console.log('üì± Page load event fired');
            setTimeout(() => {
                console.log('‚è∞ Loading timeout reached, starting transition');
                const loadingScreen = document.getElementById('loadingScreen');
                if (loadingScreen) {
                    loadingScreen.style.opacity = '0';
                    setTimeout(() => {
                        loadingScreen.style.display = 'none';
                        loadingScreen.style.position = 'absolute';
                        loadingScreen.style.visibility = 'hidden';
                        initializeTheme();
                    }, 1000);
                }
            }, 1500);

            // Backup timeout
            setTimeout(() => {
                const loadingScreen = document.getElementById('loadingScreen');
                if (loadingScreen && getComputedStyle(loadingScreen).display !== 'none') {
                    loadingScreen.style.display = 'none';
                }
            }, 5000);
        });

        // Theme initialization
        function initializeTheme() {
            if (!themeToggle) {
                console.error('‚ùå Theme toggle button not found!');
                return;
            }

            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.body.setAttribute('data-theme', savedTheme);

            updateThemeDisplay(savedTheme);
            setupThemeToggle();
        }

        // Update theme display
        function updateThemeDisplay(theme) {
            const icon = themeToggle.querySelector('i');
            if (theme === 'light') {
                if (icon) icon.className = 'fas fa-sun';
                themeToggle.title = 'Switch to Dark Mode';
                themeIndicator.textContent = '‚òÄÔ∏è LIGHT';
            } else {
                if (icon) icon.className = 'fas fa-moon';
                themeToggle.title = 'Switch to Light Mode';
                themeIndicator.textContent = 'üåô DARK';
            }
            themeIndicator.style.display = 'none'; // Keep hidden initially
        }

        // Setup theme toggle functionality
        function setupThemeToggle() {
            if (!themeToggle) return;

            console.log('‚úÖ Setting up theme toggle...');

            themeToggle.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();

                console.log('üîÑ THEME TOGGLE ACTIVATED!');

                const currentTheme = document.body.getAttribute('data-theme');
                const newTheme = (currentTheme === 'light') ? 'dark' : 'light';

                // Immediate feedback
                themeToggle.style.transform = 'scale(0.9) rotate(180deg)';
                themeToggle.style.background = '#4ecdc4';
                themeToggle.style.boxShadow = '0 0 20px #4ecdc4';

                updateThemeDisplay(newTheme);
                document.body.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);

                // Update existing charts for new theme
                if (window.Chart) {
                    updateChartsTheme();
                }

                // Show indicator
                themeIndicator.style.display = 'block';
                themeIndicator.style.opacity = '1';
                themeIndicator.style.transform = 'translateY(0)';

                // Reset toggle and hide indicator
                setTimeout(() => {
                    themeToggle.style.transform = '';
                    themeToggle.style.background = '';
                    themeToggle.style.boxShadow = '';

                    setTimeout(() => {
                        themeIndicator.style.opacity = '0';
                        themeIndicator.style.transform = 'translateY(-20px)';

                        setTimeout(() => {
                            themeIndicator.style.display = 'none';
                        }, 400);
                    }, 1500);

                    console.log('üéâ Theme switch complete!');
                }, 300);
            });

            console.log('üéØ Theme toggle setup complete!');
        }

        // Tab switching
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                tabButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');

                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(button.dataset.tab + 'Tab').classList.add('active');

                // Resize charts after tab switch to ensure they're visible
                setTimeout(() => {
                    if (overviewChart) overviewChart.resize();
                    if (statisticsChart) statisticsChart.resize();
                    if (correlationChart) correlationChart.resize();
                    if (insightsChart) insightsChart.resize();
                    if (qualityChart) qualityChart.resize();
                }, 100);
            });
        });

        // File upload handlers
        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');

            if (e.dataTransfer.files.length > 0) {
                handleFile(e.dataTransfer.files[0]);
            }
        });
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        // Change file functionality
        document.addEventListener('DOMContentLoaded', () => {
            const changeFileBtn = document.getElementById('changeFileBtn');
            if (changeFileBtn) {
                changeFileBtn.addEventListener('click', resetToUpload);
            }
        });

        // Main file handling function
        function handleFile(file) {
            if (!file.name.toLowerCase().endsWith('.csv')) {
                showError('Please select a CSV file only.');
                return;
            }

            if (file.size > 10 * 1024 * 1024) {
                showError('File size too large. Please select a file smaller than 10MB.');
                return;
            }

            hideError();
            hideSuccess();
            showLoading();

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    processCSVData(e.target.result);
                } catch (error) {
                    console.error('File processing error:', error);
                    let errorMsg = 'File processing failed. Please check your file format.';

                    if (error.message) {
                        errorMsg = error.message;

                        // Clean up error message for better readability
                        if (error.message.includes('at least a header row')) {
                            errorMsg = 'CSV file must contain at least a header row.';
                        } else if (error.message.includes('No valid column headers')) {
                            errorMsg = 'CSV file must have valid column headers.';
                        } else if (error.message.includes('No valid data rows')) {
                            errorMsg = 'CSV file must contain at least one valid data row.';
                        }
                    }

                    showError(errorMsg);
                    hideLoading();
                }
            };

            reader.onerror = function() {
                showError('File reading failed. Please try again.');
                hideLoading();
            };

            reader.readAsText(file);
        }

        // Process CSV data with improved validation
        function processCSVData(csvText) {
            try {
                if (!csvText || csvText.trim().length === 0) {
                    throw new Error('CSV file appears to be empty.');
                }

                const allLines = csvText.split(/[\r\n]+/).map(line => line.trim()).filter(line => line.length > 0);

                console.log(`Found ${allLines.length} non-empty lines`);

                if (allLines.length < 2) {
                    throw new Error('CSV file must contain at least a header row and one data row after the header.');
                }

                // Parse headers
                let headers = [];
                if (allLines.length > 0) {
                    const firstLine = allLines[0];
                    headers = firstLine.split(',').map(h => h.trim().replace(/"/g, '')).filter(h => h.length > 0);
                }

                if (headers.length === 0) {
                    throw new Error('No valid column headers found. Make sure the first line contains comma-separated column names.');
                }

                columnNames = headers;
                csvData = [];
                let parsedRows = 0;
                let skippedRows = 0;

                // Parse data rows
                for (let i = 1; i < allLines.length; i++) {
                    try {
                        const line = allLines[i];
                        if (!line || line.length < 2) {
                            skippedRows++;
                            continue;
                        }

                        const values = parseCSVLine(line, headers.length);

                        if (values.length === 0) {
                            skippedRows++;
                            continue;
                        }

                        const row = {};
                        headers.forEach((header, index) => {
                            let value = index < values.length ? values[index] : null;

                            if (value !== null && value !== undefined && value !== '' &&
                                !isNaN(value) && !isNaN(parseFloat(value))) {
                                value = parseFloat(value);
                            }

                            row[header] = value;
                        });

                        csvData.push(row);
                        parsedRows++;
                    } catch (rowError) {
                        console.warn(`Skipping problematic row ${i + 1}:`, rowError);
                        skippedRows++;
                    }
                }

                if (csvData.length === 0) {
                    throw new Error('No valid data rows could be parsed. Please check your CSV format and ensure it has data after the header row.');
                }

                console.log(`Successfully parsed ${parsedRows} data rows (${skippedRows} skipped)`);
                showSuccess(`Dataset loaded: ${csvData.length} records, ${columnNames.length} variables`);
                showNotification(`<strong>Analysis Initialized!</strong><br>Processing ${columnNames.length} variables and ${csvData.length} records...`, 'info', 6000);
                performAnalysis();

            } catch (error) {
                console.error('CSV processing error:', error);
                throw error;
            }
        }

        // Improved CSV line parser
        function parseCSVLine(line, expectedColumns) {
            const values = [];
            let currentValue = '';
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];

                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    values.push(currentValue.trim().replace(/^"|"$/g, ''));
                    currentValue = '';
                } else {
                    currentValue += char;
                }
            }

            if (currentValue || line.endsWith(',')) {
                values.push(currentValue.trim().replace(/^"|"$/g, ''));
            }

            while (values.length < expectedColumns) {
                values.push('');
            }

            return values;
        }

        // Data analysis functions
        function generateOverview() {
            return {
                totalRows: csvData.length,
                totalColumns: columnNames.length,
                numericColumns: columnNames.filter(col => csvData.some(row => typeof row[col] === 'number')).length,
                textColumns: columnNames.filter(col => csvData.some(row => typeof row[col] === 'string')).length,
                completeness: calculateDataCompleteness()
            };
        }

        function generateStatistics() {
            // Better numeric column detection: a column is numeric if at least 50% of its non-null values are numbers
            const numericCols = columnNames.filter(col => {
                const nonNullValues = csvData.filter(row => row[col] !== null && row[col] !== undefined && row[col] !== '');
                let numericCount = 0;
                nonNullValues.forEach(row => {
                    if (typeof row[col] === 'number') numericCount++;
                });
                return nonNullValues.length > 0 && numericCount >= nonNullValues.length * 0.5;
            });

            const stats = { columnStats: {} };

            numericCols.forEach(col => {
                const values = csvData.map(row => row[col]).filter(v => !isNaN(v) && v !== null);
                if (values.length > 0) {
                    stats.columnStats[col] = {
                        count: values.length,
                        mean: values.reduce((a, b) => a + b, 0) / values.length,
                        median: calculateMedian(values),
                        std: calculateStandardDeviation(values),
                        min: Math.min(...values),
                        max: Math.max(...values)
                    };
                }
            });

            return stats;
        }

        function generateCorrelations() {
            // Better numeric column detection: a column is numeric if at least 50% of its non-null values are numbers
            const numericCols = columnNames.filter(col => {
                const nonNullValues = csvData.filter(row => row[col] !== null && row[col] !== undefined && row[col] !== '');
                let numericCount = 0;
                nonNullValues.forEach(row => {
                    if (typeof row[col] === 'number') numericCount++;
                });
                return nonNullValues.length > 0 && numericCount >= nonNullValues.length * 0.5;
            });

            if (numericCols.length < 2) {
                return { correlations: [], messages: ['Less than 2 numeric columns available for correlation analysis.'] };
            }

            const correlations = [];

            for (let i = 0; i < Math.min(numericCols.length - 1, 3); i++) {
                for (let j = i + 1; j < Math.min(numericCols.length, i + 2); j++) {
                    const col1 = csvData.map(row => row[numericCols[i]]);
                    const col2 = csvData.map(row => row[numericCols[j]]);
                    const corr = calculateCorrelation(col1, col2);

                    if (Math.abs(corr) > 0.1) {
                        const strength = Math.abs(corr) > 0.8 ? 'Very Strong' : Math.abs(corr) > 0.6 ? 'Strong' : Math.abs(corr) > 0.4 ? 'Moderate' : 'Weak';
                        correlations.push({
                            var1: numericCols[i],
                            var2: numericCols[j],
                            correlation: corr,
                            strength: strength,
                            direction: corr > 0 ? 'positive' : 'negative'
                        });
                    }
                }
            }

            return { correlations: correlations.sort((a, b) => Math.abs(b.correlation) - Math.abs(a.correlation)).slice(0, 10) };
        }

        function generateInsights() {
            const insights = [];

            if (columnNames.length > 0) {
                insights.push({
                    title: 'üìä Dataset Analysis Complete',
                    description: `Successfully analyzed ${csvData.length} records with ${columnNames.length} variables.`
                });
            }

            if (analyzedData.overview) {
                const overview = analyzedData.overview;
                if (parseFloat(overview.completeness) > 95) {
                    insights.push({
                        title: 'üéØ High Data Quality',
                        description: `Dataset achieves ${overview.completeness}% completeness - excellent data governance.`
                    });
                }
            }

            return insights;
        }

        function generateQualityAssessment() {
            const totalCells = csvData.length * columnNames.length;
            let missingCells = 0;

            csvData.forEach(row => {
                columnNames.forEach(col => {
                    if (row[col] === null || row[col] === undefined || row[col] === '') {
                        missingCells++;
                    }
                });
            });

            const completenessPercent = ((totalCells - missingCells) / totalCells * 100).toFixed(1);
            const qualityScore = completenessPercent > 95 ? 'Excellent (A)' : completenessPercent > 85 ? 'Good (B)' : completenessPercent > 70 ? 'Fair (C)' : 'Poor (F)';

            return {
                totalCells,
                missingCells,
                completenessPercent: parseFloat(completenessPercent),
                qualityScore,
                recommendations: [
                    'Regular data quality audits recommended',
                    'Implement data validation rules',
                    'Set up automated data cleaning workflows'
                ]
            };
        }

        function performAnalysis() {
            try {
                analyzedData = {
                    overview: generateOverview(),
                    statistics: generateStatistics(),
                    correlations: generateCorrelations(),
                    insights: generateInsights(),
                    quality: generateQualityAssessment()
                };

                updateUI();

                // Show completion notification
                setTimeout(() => {
                    showNotification(`<strong>Analysis Complete! üéâ</strong><br>Generated 4 chart views and comprehensive statistics from your data`, 'success', 7000);
                }, 2000);

            } catch (error) {
                showError('Data analysis failed: ' + error.message);
                showNotification('<strong>Analysis Failed</strong><br>Please check your data format and try again', 'error', 10000);
                hideLoading();
            }
        }

        // Comprehensive PDF Report Generation
        function generatePDFReport() {
            try {
                // Enhanced PDF library loading check
                let jsPDFLib = window.jsPDF;
                if (!jsPDFLib && window.jspdf) {
                    jsPDFLib = window.jspdf.jsPDF;
                }

                if (!jsPDFLib) {
                    console.error('PDF library not available, attempting dynamic load...');

                    // Attempt dynamic loading as fallback
                    const script = document.createElement('script');
                    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
                    script.onload = function() {
                        console.log('PDF library loaded dynamically, retrying...');
                        setTimeout(() => generatePDFReport(), 1000);
                    };
                    script.onerror = function() {
                        alert('Unable to load PDF generator. Please check your internet connection and refresh the page.');
                    };
                    document.head.appendChild(script);
                    return;
                }

                const doc = new jsPDFLib();
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();

                // ===============================
                // PAGE 1: COVER PAGE
                // ===============================
                addCoverPage(doc, pageWidth, pageHeight);

                doc.addPage();

                // ===============================
                // PAGE 2: EXECUTIVE SUMMARY
                // ===============================
                addExecutiveSummaryPage(doc, pageWidth, pageHeight);

                doc.addPage();

                // ===============================
                // PAGE 3: DATASET OVERVIEW
                // ===============================
                addDataOverviewPage(doc, pageWidth, pageHeight);

                doc.addPage();

                // ===============================
                // PAGE 4: STATISTICAL ANALYSIS
                // ===============================
                addStatisticalAnalysisPage(doc, pageWidth, pageHeight);

                doc.addPage();

                // ===============================
                // PAGE 5: CORRELATION ANALYSIS
                // ===============================
                addCorrelationAnalysisPage(doc, pageWidth, pageHeight);

                doc.addPage();

                // ===============================
                // PAGE 6: DATA QUALITY & RECOMMENDATIONS
                // ===============================
                addQualityAndRecommendationsPage(doc, pageWidth, pageHeight);

                // ===============================
                // SAVE THE PDF
                // ===============================
                const fileName = `Advanced_Data_Analytics_Report_${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(fileName);

                // Success feedback
                const btn = document.getElementById('pdfDownloadBtn');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check-circle animate__animated animate__bounce"></i> <span class="animate__animated animate__fadeIn">PDF Downloaded!</span>';
                btn.style.background = 'linear-gradient(135deg, #28a745, #20c997)';
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.style.background = '';
                }, 4000);

            } catch (error) {
                console.error('PDF generation failed:', error);
                alert('PDF generation failed. Please try again.');
            }
        }

        // PDF Page Functions
        function addCoverPage(doc, pageWidth, pageHeight) {
            // Background rectangle
            doc.setFillColor(0, 212, 255);
            doc.rect(0, 0, pageWidth, pageHeight, 'F');

            // Header gradient effect
            doc.setFillColor(255, 255, 255, 0.9);
            doc.rect(0, 0, pageWidth, 60, 'F');

            // Main title (Compact and Professional)
            doc.setFontSize(22);
            doc.setTextColor(0, 50, 120); // Professional dark blue
            doc.text('Professional Data Analytics Report', pageWidth / 2, 35, { align: 'center' });

            doc.setFontSize(12);
            doc.setTextColor(80, 80, 80);
            doc.text('CodeAlpha Internship - Task 2', pageWidth / 2, 45, { align: 'center' });

            // Decorative lines
            doc.setDrawColor(255, 255, 255);
            doc.setLineWidth(2);
            doc.line(20, 70, pageWidth - 20, 70);

            // Center content
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(14);
            doc.text('CodeAlpha Internship - Task 2', pageWidth / 2, 120, { align: 'center' });

            doc.setFontSize(11);
            doc.text('Generated on: ' + new Date().toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            }), pageWidth / 2, 140, { align: 'center' });
            doc.text('Advanced Data Analytics Solution', pageWidth / 2, 155, { align: 'center' });

            // Bottom design elements
            doc.setDrawColor(255, 255, 255, 0.5);
            doc.setLineWidth(1);
            doc.line(50, pageHeight - 50, pageWidth - 50, pageHeight - 50);

            doc.setFontSize(10);
            doc.setTextColor(255, 255, 255, 0.8);
            doc.text('Confidential Professional Analysis | Powered by AI-Driven Analytics', pageWidth / 2, pageHeight - 30, { align: 'center' });
            doc.text('Page 1', pageWidth - 20, pageHeight - 20);
        }

        function addExecutiveSummaryPage(doc, pageWidth, pageHeight) {
            const overview = analyzedData.overview;
            const quality = analyzedData.quality;
            const stats = analyzedData.statistics;

            // Header
            doc.setFillColor(248, 249, 250);
            doc.rect(0, 0, pageWidth, 40, 'F');
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(20);
            doc.text('EXECUTIVE SUMMARY', 20, 25);

            let yPos = 60;

            doc.setFontSize(14);
            doc.setTextColor(0, 212, 255);
            doc.text('ANALYSIS OVERVIEW', 20, yPos);
            yPos += 15;

            doc.setFontSize(11);
            doc.setTextColor(0, 0, 0);

            if (overview) {
                doc.text(`‚Ä¢ Dataset contains ${overview.totalRows} records with ${overview.totalColumns} variables`, 20, yPos);
                yPos += 8;
                doc.text(`‚Ä¢ Data completeness: ${overview.completeness}% (${overview.numericColumns} numeric, ${overview.textColumns} categorical fields)`, 20, yPos);
                yPos += 12;
            }

            if (quality) {
                doc.text(`‚Ä¢ Quality Assessment: ${quality.qualityScore} with ${quality.completenessPercent}% completeness`, 20, yPos);
                yPos += 8;
                doc.text(`‚Ä¢ Missing data analysis: ${quality.missingCells} missing values out of ${quality.totalCells} total cells`, 20, yPos);
                yPos += 12;
            }

            if (stats && stats.columnStats && Object.keys(stats.columnStats).length > 0) {
                const numericVars = Object.keys(stats.columnStats).length;
                doc.text(`‚Ä¢ Statistical analysis completed for ${numericVars} numeric variables`, 20, yPos);
                yPos += 8;
                doc.text(`‚Ä¢ Comprehensive correlation and distribution analysis conducted`, 20, yPos);
                yPos += 12;
            }

            doc.setFontSize(14);
            doc.setTextColor(34, 197, 94);
            doc.text('KEY FINDINGS', 20, yPos);
            yPos += 15;

            doc.setFontSize(11);
            doc.setTextColor(0, 0, 0);

            if (quality && quality.completenessPercent > 80) {
                doc.text(`‚úì High-quality dataset with ${quality.completenessPercent}% completeness`, 20, yPos);
                yPos += 8;
            } else {
                doc.text(`‚ö†Ô∏è Data quality improvement recommended (${quality.completenessPercent}% completeness)`, 20, yPos);
                yPos += 8;
            }

            doc.text(`‚úì Professional analytics methodology applied (5-step CRISP-DM)`, 20, yPos);
            yPos += 8;
            doc.text(`‚úì Real-time visualization dashboard with responsive design`, 20, yPos);
            yPos += 12;

            // Bottom page indicator
            doc.setFontSize(10);
            doc.setTextColor(128, 128, 128);
            doc.text('Page 2 | Executive Summary', pageWidth - 20, pageHeight - 20);
        }

        function addDataOverviewPage(doc, pageWidth, pageHeight) {
            const overview = analyzedData.overview;

            // Header
            doc.setFillColor(0, 212, 255, 0.1);
            doc.rect(0, 0, pageWidth, 40, 'F');
            doc.setTextColor(0, 212, 255);
            doc.setFontSize(18);
            doc.text('DATASET OVERVIEW', 20, 25);

            let yPos = 50;

            doc.setFontSize(14);
            doc.setTextColor(0, 0, 0);
            doc.text('CORE METRICS', 20, yPos);
            yPos += 15;

            if (overview) {
                // Create a visual table
                doc.setFillColor(248, 249, 250);
                doc.rect(20, yPos - 5, pageWidth - 40, 30, 'F');

                doc.setFontSize(11);
                doc.text('Total Records:', 30, yPos + 5);
                doc.setFontSize(13);
                doc.setTextColor(0, 212, 255);
                doc.text(overview.totalRows.toString(), 70, yPos + 5);

                doc.setTextColor(0, 0, 0);
                doc.setFontSize(11);
                doc.text('Data Variables:', 120, yPos + 5);
                doc.setFontSize(13);
                doc.setTextColor(34, 197, 94);
                doc.text(overview.totalColumns.toString(), 160, yPos + 5);

                yPos += 20;

                doc.setTextColor(0, 0, 0);
                doc.setFontSize(11);
                doc.text('Numeric Fields:', 30, yPos + 5);
                doc.setFontSize(13);
                doc.setTextColor(220, 53, 69);
                doc.text(overview.numericColumns.toString(), 70, yPos + 5);

                doc.setTextColor(0, 0, 0);
                doc.setFontSize(11);
                doc.text('Categorical Fields:', 120, yPos + 5);
                doc.setFontSize(13);
                doc.setTextColor(255, 193, 7);
                doc.text(overview.textColumns.toString(), 160, yPos + 5);

                yPos += 25;

                // Completeness visualization
                doc.setFillColor(248, 249, 250);
                doc.rect(20, yPos, pageWidth - 40, 25, 'F');

                doc.setTextColor(0, 0, 0);
                doc.setFontSize(11);
                doc.text('Data Completeness:', 30, yPos + 12);

                // Progress bar
                doc.setFillColor(34, 197, 94);
                const barWidth = (parseFloat(overview.completeness) / 100) * (pageWidth - 120);
                doc.rect(100, yPos + 5, barWidth, 12, 'F');
                doc.setFillColor(255, 255, 255);
                doc.rect(100, yPos + 5, pageWidth - 120, 12, 'S');

                doc.text(`${overview.completeness}%`, pageWidth - 40, yPos + 12);
            }

            // Page indicator
            doc.setFontSize(10);
            doc.setTextColor(128, 128, 128);
            doc.text('Page 3 | Dataset Overview', pageWidth - 20, pageHeight - 20);
        }

        function addStatisticalAnalysisPage(doc, pageWidth, pageHeight) {
            const stats = analyzedData.statistics;

            // Header
            doc.setFillColor(255, 193, 7, 0.1);
            doc.rect(0, 0, pageWidth, 40, 'F');
            doc.setTextColor(255, 193, 7);
            doc.setFontSize(18);
            doc.text('STATISTICAL ANALYSIS', 20, 25);

            let yPos = 50;

            if (stats && stats.columnStats) {
                doc.setFontSize(12);
                doc.setTextColor(0, 0, 0);
                doc.text('NUMERIC VARIABLES STATISTICS', 20, yPos);
                yPos += 15;

                const sortedStats = Object.entries(stats.columnStats).slice(0, 6); // Top 6 variables

                sortedStats.forEach(([variable, stat], index) => {
                    if (yPos > pageHeight - 40) return;

                    doc.setFontSize(10);
                    doc.setTextColor(255, 193, 7);
                    const shortVar = variable.substring(0, 18);
                    doc.text(shortVar, 20, yPos);

                    // Compact layout: Count, Mean, Median, StdDev
                    doc.setFontSize(9);
                    doc.setTextColor(0, 0, 0);
                    doc.text(`${stat.count}`, 60, yPos);
                    doc.text(`${stat.mean.toFixed(1)}`, 85, yPos);
                    doc.text(`${stat.median.toFixed(1)}`, 105, yPos);
                    doc.text(`${stat.std.toFixed(1)}`, 125, yPos);

                    yPos += 12;
                });

                // Add header for statistics table
                if (sortedStats.length > 0) {
                    doc.setFontSize(8);
                    doc.setTextColor(128, 128, 128);
                    doc.text('(Count)', 60, yPos - sortedStats.length * 12 - 5);
                    doc.text('(Mean)', 85, yPos - sortedStats.length * 12 - 5);
                    doc.text('(Median)', 105, yPos - sortedStats.length * 12 - 5);
                    doc.text('(StdDev)', 125, yPos - sortedStats.length * 12 - 5);
                }
            }

            // Page indicator
            doc.setFontSize(10);
            doc.setTextColor(128, 128, 128);
            doc.text('Page 4 | Statistical Analysis', pageWidth - 20, pageHeight - 20);
        }

        function addCorrelationAnalysisPage(doc, pageWidth, pageHeight) {
            const correlations = analyzedData.correlations;

            // Header
            doc.setFillColor(220, 53, 69, 0.1);
            doc.rect(0, 0, pageWidth, 40, 'F');
            doc.setTextColor(220, 53, 69);
            doc.setFontSize(18);
            doc.text('CORRELATION ANALYSIS', 20, 25);

            let yPos = 50;

            if (correlations && correlations.correlations && correlations.correlations.length > 0) {
                doc.setFontSize(12);
                doc.setTextColor(0, 0, 0);
                doc.text('VARIABLE RELATIONSHIPS', 20, yPos);
                yPos += 15;

                doc.setFontSize(10);
                correlations.correlations.slice(0, 8).forEach((corr, index) => {
                    if (yPos > pageHeight - 30) return;

                    const strength = Math.abs(corr.correlation) > 0.7 ? 'Strong' :
                                   Math.abs(corr.correlation) > 0.5 ? 'Mod.' :
                                   Math.abs(corr.correlation) > 0.3 ? 'Weak' : 'Very Weak';

                    const direction = corr.correlation > 0 ? '+' : '-';

                    doc.setTextColor(220, 53, 69);
                    const varName = `${corr.var1.substring(0, 15)} ‚Üî ${corr.var2.substring(0, 15)}`;
                    doc.text(varName, 20, yPos);

                    doc.setTextColor(0, 0, 0);
                    doc.text(`${corr.correlation.toFixed(2)} ${direction} (${strength})`, 120, yPos);

                    yPos += 10;
                });
            } else {
                doc.setFontSize(10);
                doc.text('No significant correlations detected in the dataset.', 20, yPos);
            }

            // Page indicator
            doc.setFontSize(10);
            doc.setTextColor(128, 128, 128);
            doc.text('Page 5 | Correlation Analysis', pageWidth - 20, pageHeight - 20);
        }

        function addQualityAndRecommendationsPage(doc, pageWidth, pageHeight) {
            const quality = analyzedData.quality;

            // Header
            doc.setFillColor(34, 197, 94, 0.1);
            doc.rect(0, 0, pageWidth, 40, 'F');
            doc.setTextColor(34, 197, 94);
            doc.setFontSize(18);
            doc.text('QUALITY ASSESSMENT & RECOMMENDATIONS', 20, 25);

            let yPos = 50;

            if (quality) {
                // Quality Assessment Section
                doc.setFontSize(14);
                doc.setTextColor(34, 197, 94);
                doc.text('QUALITY METRICS', 20, yPos);
                yPos += 15;

                doc.setFontSize(11);
                doc.setTextColor(0, 0, 0);

                doc.text(`Quality Grade: ${quality.qualityScore}`, 30, yPos);
                yPos += 8;
                doc.text(`Data Completeness: ${quality.completenessPercent}%`, 30, yPos);
                yPos += 8;
                doc.text(`Total Data Points: ${quality.totalCells}`, 30, yPos);
                yPos += 8;
                doc.text(`Missing Values: ${quality.missingCells}`, 30, yPos);
                yPos += 20;

                // Recommendations Section
                doc.setFontSize(14);
                doc.setTextColor(220, 53, 69);
                doc.text('RECOMMENDATIONS', 20, yPos);
                yPos += 15;

                doc.setFontSize(11);
                doc.setTextColor(0, 0, 0);

                quality.recommendations.forEach((rec, index) => {
                    if (yPos > pageHeight - 40) return;
                    doc.text(`${index + 1}. ${rec}`, 30, yPos);
                    yPos += 10;
                });

                // Final Assessment
                yPos += 20;
                if (yPos < pageHeight - 50) {
                    doc.setFontSize(12);
                    doc.setTextColor(0, 212, 255);
                    doc.text('FINAL ASSESSMENT', 20, yPos);
                    yPos += 12;

                    doc.setFontSize(10);
                    doc.setTextColor(0, 0, 0);

                    let assessment = '';
                    if (quality.completenessPercent > 95) {
                        assessment = 'Excellent quality dataset ready for production analytics.';
                    } else if (quality.completenessPercent > 85) {
                        assessment = 'Good quality dataset with minor data completeness issues.';
                    } else if (quality.completenessPercent > 70) {
                        assessment = 'Fair quality dataset requiring data quality improvements.';
                    } else {
                        assessment = 'Poor quality dataset needing extensive data cleaning.';
                    }

                    doc.text(assessment, 30, yPos);

                    yPos += 15;
                    doc.text('Comprehensive analysis completed using advanced statistical methods and AI-driven insights.', 30, yPos);
                }
            }

            // Page indicator
            doc.setFontSize(10);
            doc.setTextColor(128, 128, 128);
            doc.text('Page 6 | Quality Assessment & Recommendations', pageWidth - 180, pageHeight - 20);
        }

        // UI update functions
        function updateUI() {
            try {
                updateOverview();
                updateStatistics();
                updateCorrelations();
                updateInsights();
                updateQuality();

                hideLoading();
                resultsSection.style.display = 'block';
                changeFileSection.style.display = 'block';

                const pdfBtn = document.getElementById('pdfDownloadBtn');
                if (pdfBtn) {
                    pdfBtn.style.display = 'flex';

                    // Add PDF download functionality
                    pdfBtn.addEventListener('click', generatePDFReport);
                }
            } catch (error) {
                showError('UI update failed: ' + error.message);
                hideLoading();
            }
        }

        function updateOverview() {
            const overview = analyzedData.overview;
            if (!overview) return;

            document.getElementById('totalRecords').textContent = overview.totalRows;
            document.getElementById('totalColumns').textContent = overview.totalColumns;
            document.getElementById('numericFields').textContent = overview.numericColumns;
            document.getElementById('textFields').textContent = overview.textColumns;

            // Create the overview chart
            if (window.Chart) {
                createOverviewChart();
            }

            // Data structure table
            let html = '<div class="chart-container"><div class="chart-title">üìã Detailed Data Structure</div>';
            html += '<div class="data-table-container"><table class="data-table"><thead><tr><th>Variable</th><th>Type</th><th>Completeness</th><th>Sample Values</th></tr></thead><tbody>';

            columnNames.forEach(col => {
                const type = csvData.some(row => typeof row[col] === 'number') ? 'Numeric' : 'Categorical';
                const nonEmpty = csvData.filter(row => row[col] !== null && row[col] !== '' && row[col] !== undefined).length;
                const completeness = ((nonEmpty / csvData.length) * 100).toFixed(1);
                const samples = csvData.slice(0, 3).map(row => String(row[col] || 'N/A')).join(', ');

                const typeColor = type === 'Numeric' ? 'var(--accent-success)' : 'var(--accent-warning)';
                html += `<tr><td>${col}</td><td><span style="color: ${typeColor}">${type}</span></td><td>${completeness}%</td><td>${samples}</td></tr>`;
            });

            html += '</tbody></table></div></div>';
            document.getElementById('overviewContent').innerHTML = html;
        }

        function updateStatistics() {
            const stats = analyzedData.statistics;
            if (!stats || !stats.columnStats) return;

            // Create statistics chart
            if (window.Chart) {
                createStatisticsChart();
            }

            // Better numeric column detection for display
            const numericCols = columnNames.filter(col => {
                const nonNullValues = csvData.filter(row => row[col] !== null && row[col] !== undefined && row[col] !== '');
                let numericCount = 0;
                nonNullValues.forEach(row => {
                    if (typeof row[col] === 'number') numericCount++;
                });
                return nonNullValues.length > 0 && numericCount >= nonNullValues.length * 0.5;
            });
            let html = '<div class="stats-grid">';

            html += `<div class="stat-card">
                <i class="fas fa-hashtag stat-icon"></i>
                <span class="stat-value">${numericCols.length}</span>
                <span class="stat-label">Numeric Variables</span>
            </div>`;

            if (Object.keys(stats.columnStats).length > 0) {
                const mostVariable = Object.entries(stats.columnStats).reduce((a, b) => (a[1].std || 0) > (b[1].std || 0) ? a : b, Object.entries(stats.columnStats)[0]);
                html += `<div class="stat-card">
                    <i class="fas fa-chart-line stat-icon"></i>
                    <span class="stat-value">${mostVariable[1].std.toFixed(1)}</span>
                    <span class="stat-label">Highest Std Dev</span>
                </div>`;
            }

            html += '</div><div class="chart-container"><div class="chart-title">üìà Statistical Distribution Analysis</div>';
            html += '<div class="data-table-container"><table class="data-table"><thead><tr><th>Variable</th><th>Count</th><th>Mean</th><th>Median</th><th>Std Dev</th><th>Min</th><th>Max</th></tr></thead><tbody>';

            Object.entries(stats.columnStats).forEach(([col, stat]) => {
                html += `<tr><td><strong>${col}</strong></td><td>${stat.count}</td><td>${stat.mean.toFixed(2)}</td><td>${stat.median.toFixed(2)}</td><td>${stat.std.toFixed(2)}</td><td>${stat.min.toFixed(2)}</td><td>${stat.max.toFixed(2)}</td></tr>`;
            });

            html += '</tbody></table></div></div>';
            document.getElementById('statisticsContent').innerHTML = html;
        }

        function updateCorrelations() {
            const correlations = analyzedData.correlations;
            if (!correlations) return;

            // Create correlation chart
            if (window.Chart) {
                createCorrelationChart();
            }

            let html = '<div class="insights"><strong>üîç Correlation Analysis Results:</strong><br><br>';

            if (correlations.correlations && correlations.correlations.length > 0) {
                correlations.correlations.forEach(corr => {
                    html += `‚Ä¢ <strong>${corr.var1} ‚Üî ${corr.var2}</strong>: ${corr.correlation.toFixed(3)} (${corr.strength} ${corr.direction})<br>`;
                });
            } else {
                html += 'No significant correlations detected.';
            }

            html += '</div>';
            document.getElementById('correlationsContent').innerHTML = html;
        }

        function updateInsights() {
            const insights = analyzedData.insights;
            if (!insights) return;

            // Create insights chart
            if (window.Chart) {
                createInsightsChart();
            }

            let html = '';
            const filteredInsights = insights.slice(0, 3);

            filteredInsights.forEach(insight => {
                const priorityColor = '#4ecdc4';
                html += `<div class="insights">
                    <span class="insight-icon">üí°</span>
                    <div>
                        <h3 style="color: ${priorityColor};">${insight.title}</h3>
                        <p>${insight.description}</p>
                    </div>
                </div>`;
            });

            document.getElementById('insightsContent').innerHTML = html;
        }

        function updateQuality() {
            const quality = analyzedData.quality;
            if (!quality) return;

            // Create quality chart
            if (window.Chart) {
                createQualityChart();
            }

            document.getElementById('qualityContent').innerHTML = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <i class="fas fa-percentage stat-icon"></i>
                        <span class="stat-value">${quality.completenessPercent}%</span>
                        <span class="stat-label">Data Completeness</span>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-star stat-icon"></i>
                        <span class="stat-value">${quality.qualityScore}</span>
                        <span class="stat-label">Quality Rating</span>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-exclamation-triangle stat-icon"></i>
                        <span class="stat-value">${quality.missingCells}</span>
                        <span class="stat-label">Missing Values</span>
                    </div>
                </div>

                <div class="insights">
                    <span class="insight-icon">üìã</span>
                    <div>
                        <h3>Data Quality Recommendations:</h3>
                        <ul>
                            ${quality.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                        </ul>
                    </div>
                </div>
            `;
        }

        // Chart rendering functions
        function getCurrentThemeColors() {
            const currentTheme = document.body.getAttribute('data-theme') || 'dark';
            const colors = {
                dark: {
                    primary: '#00d4ff',
                    secondary: '#ff6b6b',
                    success: '#4ecdc4',
                    warning: '#ffb142',
                    info: '#a8a8ff',
                    backgroundPrimary: '#2a2a2a',
                    backgroundSecondary: '#1a1a1a',
                    textPrimary: '#ffffff',
                    textSecondary: '#e0e0e0',
                    border: 'rgba(255,255,255,0.1)',
                    grid: 'rgba(255,255,255,0.1)'
                },
                light: {
                    primary: '#007bff',
                    secondary: '#dc3545',
                    success: '#28a745',
                    warning: '#ffc107',
                    info: '#17a2b8',
                    backgroundPrimary: '#ffffff',
                    backgroundSecondary: '#f8f9fa',
                    textPrimary: '#2c3e50',
                    textSecondary: '#6c757d',
                    border: 'rgba(0,0,0,0.1)',
                    grid: 'rgba(0,0,0,0.1)'
                }
            };
            return colors[currentTheme];
        }

        function createOverviewChart() {
            const overview = analyzedData.overview;
            if (!overview) return;

            const ctx = document.getElementById('overviewChart');
            if (!ctx) return;

            const colors = getCurrentThemeColors();
            const data = {
                labels: ['Numeric Variables', 'Categorical Variables'],
                datasets: [{
                    data: [overview.numericColumns, overview.textColumns],
                    backgroundColor: [colors.primary, colors.secondary],
                    borderColor: colors.backgroundPrimary,
                    borderWidth: 2,
                    hoverOffset: 15
                }]
            };

            const config = {
                type: 'doughnut',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: colors.textSecondary,
                                padding: 15,
                                usePointStyle: true,
                                font: { size: 12 }
                            }
                        }
                    }
                }
            };

            try {
                if (overviewChart) overviewChart.destroy();
                overviewChart = new Chart(ctx, config);
            } catch (error) {
                console.warn('Chart creation failed:', error);
                ctx.parentElement.innerHTML += '<div style="color: var(--text-secondary); text-align: center;">Charts may take a moment to load...</div>';
            }
        }

        function createStatisticsChart() {
            if (!analyzedData.statistics || !analyzedData.statistics.columnStats) return;

            const ctx = document.getElementById('statisticsChart');
            if (!ctx) return;

            const stats = analyzedData.statistics.columnStats;
            const numericCols = Object.keys(stats);

            if (numericCols.length === 0) return; // No numeric data available

            const labels = numericCols.slice(0, 5); // Top 5 variables
            const values = labels.map(key => stats[key].mean || 0);

            // Ensure we have data to display
            if (values.length === 0 || values.every(v => v === 0)) return;

            const colors = getCurrentThemeColors();
            const data = {
                labels: labels,
                datasets: [{
                    label: 'Mean Values',
                    data: values,
                    backgroundColor: colors.primary,
                    borderColor: colors.primary,
                    borderWidth: 2,
                    borderRadius: 8,
                    borderSkipped: false,
                }]
            };

            const config = {
                type: 'bar',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: colors.grid },
                            ticks: { color: colors.textSecondary }
                        },
                        x: {
                            grid: { color: colors.grid },
                            ticks: { color: colors.textSecondary }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: { color: colors.textSecondary }
                        }
                    }
                }
            };

            try {
                if (statisticsChart) statisticsChart.destroy();
                statisticsChart = new Chart(ctx, config);
                // Force resize to ensure chart is visible
                setTimeout(() => {
                    if (statisticsChart) statisticsChart.resize();
                }, 100);
            } catch (error) {
                console.warn('Statistics chart creation failed:', error);
                ctx.parentElement.innerHTML += '<div style="color: var(--text-secondary); text-align: center; padding: 20px;">Chart temporarily unavailable</div>';
            }
        }

        function createCorrelationChart() {
            if (!analyzedData.correlations || !analyzedData.correlations.correlations) return;

            const ctx = document.getElementById('correlationChart');
            if (!ctx) return;

            const correlations = analyzedData.correlations.correlations.slice(0, 8); // Top 8 correlations
            const colors = getCurrentThemeColors();

            const data = {
                labels: correlations.map(c => `${c.var1}\n‚Üî\n${c.var2}`),
                datasets: [{
                    label: 'Correlation Strength',
                    data: correlations.map(c => c.correlation),
                    backgroundColor: correlations.map(c => {
                        const absCorr = Math.abs(c.correlation);
                        if (absCorr > 0.7) return colors.success;
                        if (absCorr > 0.5) return colors.primary;
                        if (absCorr > 0.3) return colors.warning;
                        return colors.secondary;
                    }),
                    borderColor: correlations.map(c => {
                        const absCorr = Math.abs(c.correlation);
                        if (absCorr > 0.7) return colors.success;
                        if (absCorr > 0.5) return colors.primary;
                        if (absCorr > 0.3) return colors.warning;
                        return colors.secondary;
                    }),
                    borderWidth: 2,
                    borderRadius: 8,
                    borderSkipped: false,
                    maxBarThickness: 40
                }]
            };

            const config = {
                type: 'bar',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: colors.backgroundPrimary,
                            titleColor: colors.textPrimary,
                            bodyColor: colors.textSecondary,
                            callbacks: {
                                title: function(tooltipItems) {
                                    const index = tooltipItems[0].dataIndex;
                                    const c = correlations[index];
                                    return `${c.var1} √ó ${c.var2}`;
                                },
                                label: function(context) {
                                    const c = correlations[context.dataIndex];
                                    return `Correlation: ${c.correlation.toFixed(3)} (${c.strength} - ${c.direction})`;
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: colors.backgroundPrimary,
                            titleColor: colors.textPrimary,
                            bodyColor: colors.textSecondary
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 1,
                            min: -1,
                            grid: { color: colors.grid },
                            ticks: {
                                color: colors.textSecondary,
                                callback: function(value) {
                                    return value.toFixed(1);
                                }
                            }
                        },
                        x: {
                            grid: { color: colors.grid },
                            ticks: {
                                color: colors.textSecondary,
                                maxRotation: 0,
                                minRotation: 0
                            }
                        }
                    },
                    animation: {
                        duration: 1500,
                        easing: 'easeOutQuad'
                    }
                },
            };

            try {
                if (correlationChart) correlationChart.destroy();
                correlationChart = new Chart(ctx, config);
                // Force resize to ensure chart is visible
                setTimeout(() => {
                    if (correlationChart) correlationChart.resize();
                }, 100);
            } catch (error) {
                console.warn('Correlation chart creation failed:', error);
                ctx.parentElement.innerHTML += '<div style="color: var(--text-secondary); text-align: center; padding: 20px;">Chart temporarily unavailable</div>';
            }
        }

        function createInsightsChart() {
            const ctx = document.getElementById('insightsChart');
            if (!ctx) return;

            const overview = analyzedData.overview;
            const quality = analyzedData.quality;
            if (!overview || !quality) return;

            const colors = getCurrentThemeColors();

            // Create a beautiful doughnut chart for insights
            const score = Math.round((quality.completenessPercent + (overview.totalRows / 2) + (overview.totalColumns * 5)) / 3);

            const data = {
                labels: ['Data Health', 'Room for Improvement'],
                datasets: [{
                    data: [score, 100 - score],
                    backgroundColor: [
                        colors.success,
                        colors.secondary + '40'
                    ],
                    borderColor: [
                        colors.success,
                        colors.secondary
                    ],
                    borderWidth: 3,
                    hoverOffset: 25,
                    cutout: '65%'
                }]
            };

            const config = {
                type: 'doughnut',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: colors.textSecondary, padding: 20, usePointStyle: true }
                        },
                        tooltip: {
                            backgroundColor: colors.backgroundPrimary,
                            titleColor: colors.textPrimary,
                            bodyColor: colors.textSecondary,
                            callbacks: {
                                label: function(context) {
                                    return `${context.label}: ${context.parsed.toFixed(1)}%`;
                                }
                            }
                        },
                        centerText: {
                            display: true,
                            text: `${score}%`,
                            fontSize: 24,
                            fontWeight: 'bold',
                            color: colors.textPrimary
                        }
                    },
                    animation: {
                        duration: 2000,
                        easing: 'easeOutBounce',
                        animateScale: true,
                        animateRotate: true
                    }
                },
                plugins: [{
                    id: 'customCenterText',
                    beforeDraw: function(chart) {
                        const ctx = chart.ctx;
                        const centerX = (chart.chartArea.left + chart.chartArea.right) / 2;
                        const centerY = (chart.chartArea.top + chart.chartArea.bottom) / 2;

                        ctx.save();
                        ctx.font = `bold 24px 'Inter', sans-serif`;
                        ctx.fillStyle = chart.options.plugins.centerText.color;
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.fillText(`${score}%`, centerX, centerY - 10);

                        ctx.font = `12px 'Inter', sans-serif`;
                        ctx.fillStyle = colors.textSecondary;
                        ctx.fillText('Health Score', centerX, centerY + 15);
                        ctx.restore();
                    }
                }]
            };

            try {
                if (insightsChart) insightsChart.destroy();
                insightsChart = new Chart(ctx, config);
                // Force resize to ensure chart is visible
                setTimeout(() => {
                    if (insightsChart) insightsChart.resize();
                }, 100);
            } catch (error) {
                console.warn('Insights chart creation failed:', error);
                ctx.parentElement.innerHTML += '<div style="color: var(--text-secondary); text-align: center; padding: 20px;">Chart temporarily unavailable</div>';
            }
        }

        function createQualityChart() {
            const qualityData = analyzedData.quality;
            if (!qualityData) return;

            const ctx = document.getElementById('qualityChart');
            if (!ctx) return;

            const colors = getCurrentThemeColors();

            // Calculate quality metrics
            const completenessScore = qualityData.completenessPercent;
            const qualityGrade = qualityData.qualityScore;

            // Create a more detailed quality visualization
            const data = {
                labels: [
                    `Complete Data (${completenessScore.toFixed(1)}%)`,
                    `Missing Data (${(100 - completenessScore).toFixed(1)}%)`,
                    `Data Quality: ${qualityGrade}`
                ],
                datasets: [{
                    label: 'Data Quality Breakdown',
                    data: [completenessScore, (100 - completenessScore), 0], // Third item for grade display
                    backgroundColor: [
                        colors.success,
                        colors.secondary + '80',
                        colors.success + '00' // Transparent for grade
                    ],
                    borderColor: [
                        colors.success,
                        colors.secondary,
                        colors.success
                    ],
                    borderWidth: [2, 1, 0],
                    hoverOffset: 15,
                    cutout: '60%',
                    borderRadius: [8, 4, 0]
                }]
            };

            const config = {
                type: 'doughnut',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: colors.textSecondary,
                                padding: 20,
                                usePointStyle: true,
                                font: { size: 12 }
                            }
                        },
                        tooltip: {
                            backgroundColor: colors.backgroundPrimary,
                            titleColor: colors.textPrimary,
                            bodyColor: colors.textSecondary,
                            callbacks: {
                                label: function(context) {
                                    if (context.dataIndex === 0) {
                                        return `Complete Records: ${qualityData.totalCells - qualityData.missingCells}`;
                                    } else if (context.dataIndex === 1) {
                                        return `Missing Values: ${qualityData.missingCells}`;
                                    } else {
                                        return `Quality Rating: ${qualityGrade}`;
                                    }
                                }
                            }
                        },
                        centerText: {
                            display: true,
                            text: `${qualityGrade}`,
                            fontSize: 16,
                            fontWeight: 'bold',
                            color: colors.textPrimary,
                            secondaryText: `${completenessScore.toFixed(1)}%`,
                            secondaryFontSize: 12,
                            secondaryColor: colors.textSecondary
                        }
                    },
                    animation: {
                        duration: 2000,
                        easing: 'easeOutBounce',
                        animateScale: true,
                        animateRotate: true
                    }
                },
                plugins: [{
                    id: 'customCenterText',
                    beforeDraw: function(chart) {
                        const ctx = chart.ctx;
                        const centerX = (chart.chartArea.left + chart.chartArea.right) / 2;
                        const centerY = (chart.chartArea.top + chart.chartArea.bottom) / 2;

                        ctx.save();

                        // Main grade text
                        ctx.font = `bold 16px 'Inter', sans-serif`;
                        ctx.fillStyle = chart.options.plugins.centerText.color;
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.fillText(qualityGrade, centerX, centerY - 8);

                        // Percentage text
                        ctx.font = `12px 'Inter', sans-serif`;
                        ctx.fillStyle = chart.options.plugins.centerText.secondaryColor;
                        ctx.fillText(`${completenessScore.toFixed(1)}%`, centerX, centerY + 8);

                        ctx.restore();
                    }
                }]
            };

            try {
                if (qualityChart) qualityChart.destroy();
                qualityChart = new Chart(ctx, config);
                // Force resize to ensure chart is visible
                setTimeout(() => {
                    if (qualityChart) qualityChart.resize();
                }, 100);
            } catch (error) {
                console.warn('Quality chart creation failed:', error);
                ctx.parentElement.innerHTML += '<div style="color: var(--text-secondary); text-align: center; padding: 20px;">Chart temporarily unavailable</div>';
            }
        }

        // Chart theme update function
        function updateChartsTheme() {
            if (overviewChart) {
                overviewChart.update();
            }
            if (statisticsChart) {
                statisticsChart.update();
            }
            if (correlationChart) {
                correlationChart.update();
            }
            if (insightsChart) {
                insightsChart.update();
            }
            if (qualityChart) {
                qualityChart.update();
            }
        }

        // Utility functions
        function showError(message) {
            errorMessage.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
            errorMessage.style.display = 'block';
            successMessage.style.display = 'none';
        }

        function hideError() {
            errorMessage.style.display = 'none';
        }

        function showSuccess(message) {
            successMessage.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
            successMessage.style.display = 'block';
            errorMessage.style.display = 'none';
        }

        function hideSuccess() {
            successMessage.style.display = 'none';
        }

        function showLoading() {
            loadingSpinner.style.display = 'flex';
            uploadArea.style.display = 'none';
        }

        function hideLoading() {
            loadingSpinner.style.display = 'none';
        }

        function resetToUpload() {
            resultsSection.style.display = 'none';
            changeFileSection.style.display = 'none';
            uploadArea.style.display = 'block';

            const pdfBtn = document.getElementById('pdfDownloadBtn');
            if (pdfBtn) {
                pdfBtn.style.display = 'none';
            }

            hideError();
            hideSuccess();

            if (overviewChart) overviewChart.destroy();

            csvData = [];
            columnNames = [];
            analyzedData = {};

            console.log('File change initiated - upload area ready for new file');
        }

        function calculateDataCompleteness() {
            if (!csvData || csvData.length === 0) return 0;

            const totalCells = csvData.length * columnNames.length;
            let filledCells = 0;

            csvData.forEach(row => {
                columnNames.forEach(col => {
                    const value = row[col];
                    if (value !== null && value !== undefined && value !== '') {
                        filledCells++;
                    }
                });
            });

            return (filledCells / totalCells * 100).toFixed(1);
        }

        // Statistical utility functions
        function calculateMedian(values) {
            if (!values || values.length === 0) return 0;

            const sorted = values.slice().sort((a, b) => a - b);
            const mid = Math.floor(sorted.length / 2);

            if (sorted.length % 2 === 0) {
                return (sorted[mid - 1] + sorted[mid]) / 2;
            } else {
                return sorted[mid];
            }
        }

        function calculateStandardDeviation(values) {
            if (!values || values.length === 0) return 0;

            const mean = values.reduce((a, b) => a + b, 0) / values.length;
            const squareDiffs = values.map(value => Math.pow(value - mean, 2));
            const variance = squareDiffs.reduce((a, b) => a + b, 0) / values.length;

            return Math.sqrt(variance);
        }

        function calculateCorrelation(x, y) {
            if (!x || !y || x.length !== y.length || x.length < 2) return 0;

            const n = x.length;

            // Calculate means
            const meanX = x.reduce((a, b) => a + b, 0) / n;
            const meanY = y.reduce((a, b) => a + b, 0) / n;

            // Calculate covariance and standard deviations
            let numerator = 0;
            let sumX2 = 0;
            let sumY2 = 0;

            for (let i = 0; i < n; i++) {
                const dx = x[i] - meanX;
                const dy = y[i] - meanY;

                numerator += dx * dy;
                sumX2 += dx * dx;
                sumY2 += dy * dy;
            }

            const denominator = Math.sqrt(sumX2 * sumY2);

            if (denominator === 0) return 0;

            return numerator / denominator;
        }

        // Scroll Animations
        const observerOptions = {
            threshold: 0.1,
            rootMargin: '0px 0px -50px 0px'
        };

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('animate__animated', 'animate__fadeInUp');
                }
            });
        }, observerOptions);

        // Observe all step cards and data tables
        document.querySelectorAll('.step, .data-table, .insights, .chart-container').forEach(el => {
            observer.observe(el);
        });

        // Notification System
        function showNotification(message, type = 'info', duration = 5000) {
            const notification = document.getElementById('floatingNotification');
            if (!notification) return;

            notification.className = 'notification';
            notification.classList.add(type);

            // Clear any existing content and set new message
            notification.innerHTML = '';

            // Add appropriate icon
            const iconClass = 'fas fa-' + (type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : type === 'warning' ? 'exclamation-circle' : 'info-circle');
            const icon = document.createElement('i');
            icon.className = iconClass;
            notification.appendChild(icon);

            // Add message
            const messageDiv = document.createElement('div');
            messageDiv.innerHTML = message;
            notification.appendChild(messageDiv);

            // Show notification
            notification.style.display = 'block';

            // Auto-hide after duration
            setTimeout(() => {
                notification.style.display = 'none';
            }, duration);
        }

        function hideNotification() {
            const notification = document.getElementById('floatingNotification');
            if (notification) {
                notification.style.display = 'none';
            }
        }

        // Show welcome notification on page load
        setTimeout(() => {
            showNotification('<strong>Welcome to Advanced Analytics!</strong><br>Upload a CSV file to explore your data like never before ‚ú®', 'success', 8000);
        }, 3000);

        // Enhanced document ready
        function initializeAnalytics() {
            console.log('üéØ Initializing Cinematic Analytics Dashboard...');

            // Add loading animation enhancement
            const loadingSpinner = document.getElementById('loadingSpinner');
            if (loadingSpinner) {
                const spinnerDiv = loadingSpinner.querySelector('.loading-spinner');
                if (spinnerDiv) {
                    spinnerDiv.className = 'advanced-loader';
                }
            }

            // Add magnetic effects to buttons
            document.querySelectorAll('.tab-button, .upload-button, .pdf-download-btn').forEach(btn => {
                btn.classList.add('btn-magnetic');
            });

            console.log('üöÄ Advanced Data Analytics Dashboard - CodeAlpha Task 2');
            console.log('‚úÖ All systems initialized with cinematic effects!');
        }

        // Initialize on DOM ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeAnalytics);
        } else {
            initializeAnalytics();
        }
    </script>
</body>
</html>